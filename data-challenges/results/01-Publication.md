# ESGF-NG Data Challenge 01: Publication with Index Synchronization

## Round 1 Results

### Overview
As decided in the face-to-face meeting on November 2024, the first round of Data Challenge One includes using the ESGF core architecture to publish (POST) events from the esg-publisher to a cloud-deployed STAC Transaction API which sends events to a managed Kafka queue. The event contains information about the authenticity of the publisher along with STAC compliant CMIP6 dataset(s). A Kafka Consumer listening on a topic within the Kafka queue will ingest the datasets to a Globus search index.

### What is needed to run Data Challenge 1 Round 1?
* [500 E3SM datasets for publication](https://g-52ba3.fd635.8443.data.globus.org/users/lukasz/esgf2/dc_west_metadata_500.tgz)
* esg-publisher
  * Globus Native App client_id
* Running STAC Transaction API
  * Globus client ID and secret with the `view_my_groups_and_memberships_scope_uuid`
 * Apache Kafka running with appropriately created topics
  * Local Kafka cluster with docker compose
  * Confluent Cloud Kafka cluster with SASL authentication
 * Kafka consumer subscribed to appropriate topics in the queue
   * Globus Search index with appropriate writer permissions
 * [esgf-validate](https://github.com/esgf2-us/esgf-validate) for validating east and west indices are synced

### How is Data Challenge 1 Round 1 run?
* esg-publisher uses the JSON publication records from the E3SM datasets mentioned above and sends a POST event to the STAC Transaction API
* The STAC Transaction API picks up the event and runs a Kafka producer to send it to the Kakfa queue
* A Kafka consumer subscribed to a specific topic retrieves the event, reads the data, and ingests it into a Globus search index
* After both East and West run the above steps, the Globus (West) and Elasticsearch (East) indices should be synchronized
* To check the above, run the esgf-validate scripts created by ORNL

### Results of Data Challenge 1 Round 1
After running through the above steps, the validation script detected the following:
* All items existed in each index. In other words, the same number of items existed in the West as in the East
  * There was one duplicate, so each index reported 999 items after synchronization
* There were differences in property values for each item. Please see an example below.
  * `dictionary_item_added` means the property exists in the com but not in the ref
    * CEDA has `updated` and `created` properties that the West does not have
  * `dictionary_item_removed` means the property does not exist in the com
    * CEDA is using `alternate:name` not `name`. CEDA is investigating a fix. 
  * `values_changed` indicates properties that are not the same across indices
    * This error can essentially be ignored. CEDA is investigating the lower-case discrenpancy for the project value (CMIP6). The `links` property is generated by the discovery service and is expected to be different across indices.
```
2025-03-06 13:45:41 ref = https://data-challenge-01.api.stac.esgf-west.org/
2025-03-06 13:45:41 com = https://api.stac.esgf.ceda.ac.uk/collections
2025-03-06 13:45:42 differences found!
id=CMIP6.CMIP.E3SM-Project.E3SM-2-0.historical.r5i1p1f1.Amon.pr.gr.v20220901
dictionary_item_added: !!python/object/new:deepdiff.helper.SetOrdered
  state:
  - root['properties']['created']
  - root['properties']['updated']
dictionary_item_removed: !!python/object/new:deepdiff.helper.SetOrdered
  state:
  - root['assets']['globus']['name']
  - root['assets']['data0000']['name']
  - root['assets']['data0001']['name']
  - root['assets']['data0002']['name']
  - root['assets']['data0003']['name']
values_changed:
  root['collection']:
    com_value: cmip6
    ref_value: CMIP6
  root['links'][0]['href']:
    com_value: https://api.stac.esgf.ceda.ac.uk/collections/cmip6/items/CMIP6.CMIP.E3SM-Project.E3SM-2-0.historical.r5i1p1f1.Amon.pr.gr.v20220901
    ref_value: https://data-challenge-01.api.stac.esgf-west.org/collections/CMIP6/items/CMIP6.CMIP.E3SM-Project.E3SM-2-0.historical.r5i1p1f1.Amon.pr.gr.v20220901
  root['links'][1]['href']:
    com_value: https://api.stac.esgf.ceda.ac.uk/collections/cmip6
    ref_value: https://data-challenge-01.api.stac.esgf-west.org/collections/CMIP6
  root['links'][2]['href']:
    com_value: https://api.stac.esgf.ceda.ac.uk/collections/cmip6
    ref_value: https://data-challenge-01.api.stac.esgf-west.org/collections/CMIP6
  root['links'][3]['href']:
    com_value: https://api.stac.esgf.ceda.ac.uk/
    ref_value: https://data-challenge-01.api.stac.esgf-west.org/
```

### To-do Items
- [] CEDA to investigate fixing lower-case `project` property value `cmip6` to `CMIP6`
- [] CEDA to investigate fixing `alternate:name` property to `alternate`